FROM node:lts-alpine AS ssl-builder

WORKDIR /build

# Add script
COPY ./ssl.js ./
# Add config
COPY ./config ./config

# Upgrade
RUN apk update \ 
  && apk upgrade -U -a \
  && apk add --no-cache openssl \
  # Build SSL certifcates
  && npm i pem \
  && export NODE_ENV=production \
  && node ssl.js \
  # Make it fetchable
  && mkdir /app \
  && mv ssl/ config/ /app/

# ====

FROM httpd:alpine

WORKDIR /usr/local/apache2/htdocs

# Add project files
COPY --from=ssl-builder /app ./

# Upgrade + install driver
RUN apk update \
  && apk upgrade -U -a \
  # Add config files
  && mkdir /usr/local/apache2/conf/conf.d/ \
  && mv -v ./config/apache2/* /usr/local/apache2/conf/conf.d/ \
  && echo "Include /usr/local/apache2/conf/conf.d/*.conf" >> /usr/local/apache2/conf/httpd.conf
